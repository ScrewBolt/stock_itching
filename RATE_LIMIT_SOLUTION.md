# è§£æ±º API Rate Limit (429 éŒ¯èª¤) å•é¡Œ

## ğŸ”´ å•é¡Œèªªæ˜

**éŒ¯èª¤è¨Šæ¯**ï¼š
```
429 Client Error: Too Many Requests for url: https://query2.finance.yahoo.com/...
```

**åŸå› **ï¼š
- Yahoo Finance API æœ‰é€Ÿç‡é™åˆ¶
- çŸ­æ™‚é–“å…§ç™¼é€å¤ªå¤šè«‹æ±‚æœƒè¢«æš«æ™‚å°é–
- é€šå¸¸æŒçºŒ 5-15 åˆ†é˜

## âœ… å·²å¯¦ä½œçš„æ”¹é€²

### 1. æ™ºèƒ½ Rate Limiting

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… è«‹æ±‚ä¹‹é–“è‡ªå‹•é–“éš”è‡³å°‘ 2 ç§’
- âœ… é‡åˆ° 429 éŒ¯èª¤æ™‚è‡ªå‹•ç­‰å¾… 60 ç§’
- âœ… é€£çºŒé‡åˆ°éŒ¯èª¤æ™‚ç­‰å¾…æ™‚é–“éå¢
- âœ… è‡ªå‹•èª¿æ•´å¾ŒçºŒè«‹æ±‚é–“éš”

**ç¨‹å¼ç¢¼æ”¹é€²**ï¼š
```python
# æ–°å¢çš„åŠŸèƒ½
self._last_request_time = None
self._min_request_interval = 2.0      # æœ€å°é–“éš” 2 ç§’
self._rate_limit_wait = 60            # é‡åˆ° 429 ç­‰å¾… 60 ç§’

# æ™ºèƒ½ç­‰å¾…æ©Ÿåˆ¶
def _wait_for_rate_limit(self):
    if self._last_request_time is not None:
        elapsed = time.time() - self._last_request_time
        if elapsed < self._min_request_interval:
            wait_time = self._min_request_interval - elapsed
            time.sleep(wait_time)
    self._last_request_time = time.time()

# 429 éŒ¯èª¤ç‰¹æ®Šè™•ç†
if "429" in error_msg:
    wait_time = self._rate_limit_wait * attempt  # éå¢ç­‰å¾…
    self.logger.warning(f"é‡åˆ° API Rate Limitï¼Œç­‰å¾… {wait_time} ç§’...")
    time.sleep(wait_time)
```

## ğŸ”§ ä½¿ç”¨å»ºè­°

### æ–¹æ¡ˆ 1ï¼šèª¿æ•´æª¢æŸ¥é »ç‡ï¼ˆæ¨è–¦ï¼‰

ç·¨è¼¯ `.env` æª”æ¡ˆï¼š

```bash
# é™ä½æª¢æŸ¥é »ç‡ï¼Œé¿å…è§¸ç™¼é™åˆ¶
CHECK_INTERVAL_MINUTES=10   # æ”¹ç‚º 10 åˆ†é˜ï¼ˆåŸæœ¬ 5 åˆ†é˜ï¼‰

# å¢åŠ é‡è©¦å»¶é²
RETRY_DELAY_SECONDS=10      # æ”¹ç‚º 10 ç§’ï¼ˆåŸæœ¬ 5 ç§’ï¼‰
```

**é‡å•Ÿå¾Œç”Ÿæ•ˆ**ï¼š
```bash
# åœæ­¢ç¨‹å¼ï¼ˆCtrl+Cï¼‰
# é‡æ–°å•Ÿå‹•
python3 main.py
```

### æ–¹æ¡ˆ 2ï¼šæ¸›å°‘ç›£æ§æ•¸é‡

å¦‚æœç›£æ§å¾ˆå¤šè‚¡ç¥¨ï¼š
```bash
# æŸ¥çœ‹ç›£æ§æ¸…å–®
/list

# æ¸…ç©ºä¸éœ€è¦çš„ç›£æ§
/clearstock SYMBOL
# æˆ–æ¸…ç©ºå…¨éƒ¨
/clear
```

**å»ºè­°**ï¼šåŒæ™‚ç›£æ§ä¸è¶…é 20-30 å€‹è‚¡ç¥¨

### æ–¹æ¡ˆ 3ï¼šç­‰å¾… API é™åˆ¶è§£é™¤

**ç«‹å³è¡Œå‹•**ï¼š
```bash
# 1. åœæ­¢ç¨‹å¼
æŒ‰ Ctrl+C

# 2. ç­‰å¾… 10-15 åˆ†é˜

# 3. é‡æ–°å•Ÿå‹•
python3 main.py
```

### æ–¹æ¡ˆ 4ï¼šä½¿ç”¨ä»£ç†æˆ– VPNï¼ˆé€²éšï¼‰

å¦‚æœé »ç¹é‡åˆ°é™åˆ¶ï¼Œå¯ä»¥è€ƒæ…®ï¼š
- æ›´æ› IP ä½å€
- ä½¿ç”¨ä»£ç†æœå‹™
- ä½¿ç”¨ VPN

## ğŸ“Š Yahoo Finance API é™åˆ¶èªªæ˜

### å®˜æ–¹é™åˆ¶ï¼ˆä¼°è¨ˆå€¼ï¼‰

| é™åˆ¶é¡å‹ | æ•¸å€¼ |
|---------|------|
| æ¯åˆ†é˜è«‹æ±‚ | ~60 æ¬¡ |
| æ¯å°æ™‚è«‹æ±‚ | ~2,000 æ¬¡ |
| æ¯å¤©è«‹æ±‚ | ~48,000 æ¬¡ |

**æ³¨æ„**ï¼šé€™äº›æ˜¯ç¤¾ç¾¤ä¼°è¨ˆå€¼ï¼Œå®˜æ–¹æœªå…¬é–‹å…·é«”é™åˆ¶

### è§¸ç™¼é™åˆ¶çš„å¸¸è¦‹åŸå› 

1. **çŸ­æ™‚é–“å¤§é‡è«‹æ±‚**
   - åŒæ™‚ç›£æ§å¤ªå¤šè‚¡ç¥¨
   - æª¢æŸ¥é »ç‡å¤ªé«˜ï¼ˆ< 5 åˆ†é˜ï¼‰

2. **æ¸¬è©¦æ™‚å¤§é‡æŸ¥è©¢**
   - åŸ·è¡Œæ¸¬è©¦æ™‚ç™¼é€å¤§é‡è«‹æ±‚
   - é–‹ç™¼æ™‚é »ç¹æ¸¬è©¦

3. **å…±äº« IP**
   - å¤šäººä½¿ç”¨åŒä¸€ IP
   - å…¬å¸/å­¸æ ¡ç¶²è·¯

## ğŸ¯ æœ€ä½³å¯¦è¸

### å»ºè­°è¨­å®š

**é©åˆå€‹äººä½¿ç”¨**ï¼ˆç›£æ§ 5-10 å€‹è‚¡ç¥¨ï¼‰ï¼š
```bash
CHECK_INTERVAL_MINUTES=5
RETRY_DELAY_SECONDS=5
```

**é©åˆç›£æ§è¼ƒå¤šè‚¡ç¥¨**ï¼ˆ10-30 å€‹ï¼‰ï¼š
```bash
CHECK_INTERVAL_MINUTES=10
RETRY_DELAY_SECONDS=10
```

**é©åˆå¤§é‡ç›£æ§**ï¼ˆ30+ å€‹è‚¡ç¥¨ï¼‰ï¼š
```bash
CHECK_INTERVAL_MINUTES=15
RETRY_DELAY_SECONDS=15
```

### ä½¿ç”¨æŠ€å·§

1. **é¿å…é »ç¹æ¸¬è©¦**
   ```bash
   # æ¸¬è©¦æ™‚ä½¿ç”¨ Mock æ•¸æ“šï¼Œä¸è¦çœŸå¯¦æŸ¥è©¢
   python3 -m unittest tests.test_stock_fetcher -v
   ```

2. **åˆ†æ‰¹æ–°å¢ç›£æ§**
   ```bash
   # ä¸è¦ä¸€æ¬¡æ–°å¢å¤ªå¤šç›£æ§
   # æ¯æ¬¡æ–°å¢å¾Œç­‰å¾…ç³»çµ±æª¢æŸ¥ä¸€æ¬¡
   /add AAPL above 150
   # ç­‰å¾… 5-10 åˆ†é˜
   /add GOOGL above 140
   ```

3. **å®šæœŸæ¸…ç†**
   ```bash
   # å®šæœŸæ¸…ç†ä¸éœ€è¦çš„ç›£æ§
   /list
   /remove <ID>
   ```

## ğŸ” ç›£æ§é‹è¡Œç‹€æ…‹

### æŸ¥çœ‹æ—¥èªŒ

```bash
# æŸ¥çœ‹æœ€è¿‘çš„æ—¥èªŒ
tail -f logs/app.log

# æœå°‹ Rate Limit éŒ¯èª¤
grep "429\|Rate Limit" logs/error.log
```

### æª¢æŸ¥ç³»çµ±ç‹€æ…‹

```bash
# æŸ¥çœ‹ç•¶å‰ç›£æ§æ•¸é‡
/list

# åœ¨æ—¥èªŒä¸­çœ‹åˆ°çš„æ­£å¸¸è¨Šæ¯ï¼š
# "æˆåŠŸæŸ¥è©¢ 5/5 å€‹è‚¡ç¥¨"
# "æ²’æœ‰ç›£æ§è¢«è§¸ç™¼"
```

## ğŸ†˜ ä»ç„¶ç„¡æ³•è§£æ±ºï¼Ÿ

### è¨ºæ–·æ­¥é©Ÿ

1. **æª¢æŸ¥ç¶²è·¯**
   ```bash
   curl -I https://query2.finance.yahoo.com
   ```

2. **æª¢æŸ¥ IP æ˜¯å¦è¢«å°é–**
   ```bash
   # åœ¨ç€è¦½å™¨è¨ªå•
   https://finance.yahoo.com
   ```

3. **æŸ¥çœ‹è©³ç´°éŒ¯èª¤**
   ```bash
   tail -100 logs/error.log
   ```

### æ›¿ä»£æ–¹æ¡ˆ

å¦‚æœå•é¡ŒæŒçºŒï¼Œå¯ä»¥è€ƒæ…®ï¼š

1. **ä½¿ç”¨å…¶ä»– API**
   - Alpha Vantage
   - IEX Cloud
   - Finnhub

2. **ä»˜è²» API**
   - æ›´é«˜çš„é€Ÿç‡é™åˆ¶
   - æ›´ç©©å®šçš„æœå‹™

3. **æœ¬åœ°å¿«å–**
   - å¯¦ä½œåƒ¹æ ¼å¿«å–æ©Ÿåˆ¶
   - æ¸›å°‘é‡è¤‡æŸ¥è©¢

## ğŸ“ˆ æ”¹é€²å¾Œçš„æ•ˆæœ

**ä¿®æ­£å‰**ï¼š
- âŒ é »ç¹è§¸ç™¼ 429 éŒ¯èª¤
- âŒ ç„¡æ™ºèƒ½ç­‰å¾…æ©Ÿåˆ¶
- âŒ å›ºå®šé‡è©¦é–“éš”

**ä¿®æ­£å¾Œ**ï¼š
- âœ… è‡ªå‹•é–“éš”è«‹æ±‚ï¼ˆ2 ç§’ï¼‰
- âœ… 429 éŒ¯èª¤ç‰¹æ®Šè™•ç†ï¼ˆç­‰å¾… 60 ç§’ï¼‰
- âœ… å‹•æ…‹èª¿æ•´è«‹æ±‚é–“éš”
- âœ… éå¢ç­‰å¾…æ™‚é–“

---

**æ›´æ–°æ—¥æœŸ**ï¼š2026-01-29
**ç‰ˆæœ¬**ï¼šv1.1.1
